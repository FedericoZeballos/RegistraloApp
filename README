# ğŸš€ RegistraloApp - GuÃ­a RÃ¡pida

## âš¡ InstalaciÃ³n y EjecuciÃ³n RÃ¡pida (Windows)

### 1. Prerrequisitos
```powershell
# Instalar PostgreSQL (postgresql.org)
# Durante instalaciÃ³n: usuario 'postgres', password 'admin', puerto 5432

# Instalar Memurai (Redis para Windows)
# Descargar desde memurai.com - Developer Edition (gratis)
```

### 2. Configurar Base de Datos
```powershell
# Crear base de datos
"C:\Program Files\PostgreSQL\17\bin\createdb.exe" -h localhost -p 5432 -U postgres registralo_db

# Verificar Redis
"C:\Program Files\Memurai\memurai-cli.exe" ping  # Debe responder: PONG
```

### 3. Configurar Proyecto
```powershell
# Clonar y activar entorno
git clone <tu-repo>
cd RegistraloApp
python -m venv venv
.\venv\Scripts\Activate.ps1
pip install -r requirements.txt

# Crear archivo .env en la raÃ­z:
echo "DB_USER=postgres
DB_PASSWORD=admin
DB_HOST=localhost
DB_PORT=5432
DB_NAME=registralo_db
REDIS_URL=redis://localhost:6379/0
ADMIN_PASSWORD=admin" > .env

# Crear usuario admin
python create_admin.py
```

### 4. Ejecutar AplicaciÃ³n
```powershell
uvicorn app.main:app --reload
```

### 5. ğŸ¯ Acceder a la App
- **API Docs**: http://127.0.0.1:8000/docs
- **Admin Panel**: http://127.0.0.1:8000/admin (usuario: `admin`, password: `admin`)
- **API Root**: http://127.0.0.1:8000/

---

## ğŸ“ DocumentaciÃ³n Detallada

PARA LEVANTAR EL SERVIDOR:
uvicorn app.main:app --reload

----------------------------------------------------------------------------------------------------------------------------

ğŸ‘‰ AbrÃ­ en navegador:
http://127.0.0.1:8000/docs
y tendrÃ¡s la UI interactiva de la API.

----------------------------------------------------------------------------------------------------------------------------

ğŸ“Œ Con esto ya tenÃ©s:
    -- FastAPI corriendo.
    -- PostgreSQL conectado vÃ­a SQLAlchemy.
    -- Endpoints para crear y listar compras.
    -- ORM listo para escalar y hacer consultas complejas mÃ¡s adelante.

----------------------------------------------------------------------------------------------------------------------------

RegistraloApp/
â”‚â”€â”€ alembic/               # migraciones automÃ¡ticas
â”‚â”€â”€ app/
â”‚   â”œâ”€â”€ core/              # configuraciÃ³n
â”‚   â”‚   â””â”€â”€ database.py
â”‚   â”œâ”€â”€ models/            # modelos ORM
â”‚   â”‚   â””â”€â”€ compra.py
â”‚   â”œâ”€â”€ schemas/           # Pydantic schemas
â”‚   â”‚   â””â”€â”€ compra.py
â”‚   â”œâ”€â”€ crud/              # operaciones CRUD
â”‚   â”‚   â””â”€â”€ compra.py
â”‚   â”œâ”€â”€ routers/           # rutas de la API
â”‚   â”‚   â””â”€â”€ compra.py
â”‚   â””â”€â”€ main.py            # punto de entrada
â””â”€â”€ alembic.ini


----------------------------------------------------------------------------------------------------------------------------


COMANDOS CORRIDOS PARA CREAR EL PROYECTO:
    PARA INICIAR PROYECTO:
        python -m venv venv
        .\venv\Scripts\Activate.ps1
        pip install fastapi uvicorn sqlalchemy psycopg2-binary alembic pydantic
        python -m pip install --upgrade pip

    CREAR ESTRUCTURA DE CARPETAS:
        mkdir app
        mkdir app\routers
        mkdir app\models
        mkdir app\schemas
        mkdir app\crud
        mkdir app\core


    PARA INICIAR EL PROYECTO:
        venv\Scripts\activate                  //Asegurate de estar posicionado.
        python create_admin.py                //Primero corre el script para crear un usuario.
        uvicorn app.main:app --reload         // Levanta el proyecto.
        
----------------------------------------------------------------------------------------------------------------------------


Para una entidad Compra, podrÃ­as tener:

    app/models/compra.py â†’ el modelo ORM (SQLAlchemy).

    app/schemas/compra.py â†’ el esquema Pydantic (validaciÃ³n de entrada/salida).

    app/crud/compra.py â†’ funciones CRUD (create, read, update, delete).

    app/routers/compra.py â†’ las rutas de la API relacionadas con compras.

ğŸ“Œ Esto hace que el proyecto escale mejor cuando tengas mÃ¡s entidades (Ej: Usuario, CategorÃ­a, etc.).


----------------------------------------------------------------------------------------------------------------------------

## ğŸš€ CONFIGURACIÃ“N SIN DOCKER (Windows)

### Problema Original
La app estaba configurada para Docker, pero necesitÃ¡bamos correrla localmente en Windows sin virtualizaciÃ³n habilitada.

### âœ… SoluciÃ³n Completa

#### 1. Instalar PostgreSQL (Windows nativo)
```powershell
# Descargar e instalar PostgreSQL desde postgresql.org
# Durante instalaciÃ³n: usuario 'postgres', password 'admin', puerto 5432

# Crear la base de datos
"C:\Program Files\PostgreSQL\17\bin\createdb.exe" -h localhost -p 5432 -U postgres registralo_db

# Verificar servicio activo
Get-Service -Name "postgresql*"
```

#### 2. Instalar Redis (Memurai para Windows)
```powershell
# Instalar Memurai Developer Edition (gratis)
# Probar conexiÃ³n:
"C:\Program Files\Memurai\memurai-cli.exe" ping
# Debe responder: PONG
```

#### 3. Archivo .env (raÃ­z del proyecto)
```bash
DB_USER=postgres
DB_PASSWORD=admin
DB_HOST=localhost
DB_PORT=5432
DB_NAME=registralo_db

REDIS_URL=redis://localhost:6379/0
ADMIN_PASSWORD=admin
```

#### 4. Dependencias (requirements.txt ya listo)
```powershell
python -m venv venv
.\venv\Scripts\Activate.ps1
pip install -r requirements.txt
```

#### 5. MigraciÃ³n a Tortoise ORM
**CAMBIO CRÃTICO**: Convertimos toda la app de SQLAlchemy a **Tortoise ORM** porque fastapi-admin solo funciona con Tortoise.

- âŒ Eliminamos: `app/models/compra.py` (SQLAlchemy)
- âŒ Eliminamos: `app/crud/compra.py` (CRUD SQLAlchemy)  
- âœ… Usamos: `app/models/compra_tortoise.py` (modelo Ãºnico)
- âœ… Actualizamos: `app/routers/compra.py` con mÃ©todos Tortoise

#### 6. ConfiguraciÃ³n FastAPI Admin
**PROBLEMA**: fastapi-admin necesita setup especÃ­fico para funcionar.

**Soluciones aplicadas**:

**A) Orden de inicializaciÃ³n correcto** (`app/main.py`):
```python
@app.on_event("startup")
async def on_startup():
    # PRIMERO: Inicializar Tortoise
    await Tortoise.init(
        db_url=db_url,
        modules={"models": ["app.models.admin_user", "app.models.compra_tortoise"]},
    )
    await Tortoise.generate_schemas()
    
    # SEGUNDO: Inicializar admin (cuando Tortoise ya estÃ¡ listo)
    await init_admin(app)
```

**B) Nombre del modelo compatible** (`app/models/compra_tortoise.py`):
```python
class compras(Model):  # nombre en minÃºsculas = URL /admin/compras/list
    class Meta:
        table = "compras"
```

**C) Incluir router de recursos** (`app/admin.py`):
```python
# Crear admin_app y incluir router de recursos
admin_app = FastAPIAdmin()

# CRÃTICO: Incluir router de recursos manualmente
from fastapi_admin.routes import router as admin_router
admin_app.include_router(admin_router)
```

**D) Hash de contraseÃ±as**: Usar bcrypt (no argon2) para compatibilidad.

#### 7. Crear usuario admin
```powershell
python create_admin.py
# Output: "ContraseÃ±a del usuario admin actualizada."
```

#### 8. Levantar la aplicaciÃ³n
```powershell
uvicorn app.main:app --reload
```

### ğŸ¯ URLs de la AplicaciÃ³n
- **API Docs**: http://127.0.0.1:8000/docs
- **API Root**: http://127.0.0.1:8000/
- **Admin Panel**: http://127.0.0.1:8000/admin (usuario: `admin`, password: `admin`)
- **Lista Compras**: http://127.0.0.1:8000/admin/compras/list

### ğŸ› Problemas Resueltos
1. **"Invalid salt"**: Conflicto argon2 vs bcrypt â†’ Usar bcrypt nativo
2. **"carga infinita"**: Orden de inicializaciÃ³n â†’ Tortoise antes que admin
3. **404 en admin**: Router de recursos faltante â†’ Incluir manualmente
4. **Modelos no encontrados**: Nombre incompatible â†’ clase `compras` minÃºsculas
5. **Dos ORMs**: SQLAlchemy + Tortoise â†’ Solo Tortoise

### ğŸ“Š Estado Final
âœ… PostgreSQL local (4 compras en tabla)  
âœ… Redis local (Memurai)  
âœ… FastAPI + Tortoise ORM unificado  
âœ… Admin panel funcional con CRUD  
âœ… API endpoints operativos  
âœ… Sin dependencias de Docker  

----------------------------------------------------------------------------------------------------------------------------